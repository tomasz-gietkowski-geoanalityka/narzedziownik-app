name: Build QGIS Plugin ZIP

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

env:
  # NAZWA katalogu top-level w ZIP (PEP8/identifier — bez spacji i polskich znaków)
  PLUGIN_NAME: narzedziownik_app

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Locate plugin source dir (with metadata.txt)
        id: locate
        shell: bash
        run: |
          set -euo pipefail

          echo "Repo root listing:"
          ls -la

          # Domyślnie zakładamy root repo
          SRC_DIR="."

          # Jeśli w root nie ma metadata.txt, spróbuj znaleźć najbliższy katalog który go ma
          if [ ! -f "metadata.txt" ]; then
            CANDIDATE="$(git ls-files '*/metadata.txt' | head -n1 || true)"
            if [ -n "$CANDIDATE" ]; then
              SRC_DIR="$(dirname "$CANDIDATE")"
            fi
          fi

          if [ ! -f "$SRC_DIR/metadata.txt" ]; then
            echo "Nie znaleziono metadata.txt ani w root, ani w podkatalogach." >&2
            exit 1
          fi

          echo "Zidentyfikowano katalog źródłowy wtyczki: $SRC_DIR"
          echo "src_dir=$SRC_DIR" >> "$GITHUB_OUTPUT"

          echo "Listing katalogu źródłowego:"
          ls -la "$SRC_DIR"

      - name: Prepare staging
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "dist/${{ env.PLUGIN_NAME }}"

          SRC_DIR="${{ steps.locate.outputs.src_dir }}"

          # Bardzo ważne: trailing slash po SRC_DIR, by skopiować *zawartość*, nie katalog jako podkatalog
          rsync -av \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'dist' \
            --exclude 'tests' \
            --exclude '__pycache__' \
            --exclude '*.psd' \
            --exclude '*.ai' \
            --exclude '*.zip' \
            --exclude '.gitignore' \
            --exclude '.gitattributes' \
            "${SRC_DIR}/" "dist/${{ env.PLUGIN_NAME }}/"

          echo "Listing staging (dist/${{ env.PLUGIN_NAME }}):"
          ls -la "dist/${{ env.PLUGIN_NAME }}"

          # sanity check – te pliki MUSZĄ być na poziomie top-level w stagingu
          test -f "dist/${{ env.PLUGIN_NAME }}/metadata.txt"
          test -f "dist/${{ env.PLUGIN_NAME }}/__init__.py" || {
            echo "__init__.py nie znaleziony w katalogu staging! Upewnij się, że znajduje się obok metadata.txt." >&2
            exit 1
          }

      - name: Create ZIP with correct top-level dir
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          zip -r "${{ env.PLUGIN_NAME }}.zip" "${{ env.PLUGIN_NAME }}"
          echo "Zawartość ZIP:"
          unzip -l "${{ env.PLUGIN_NAME }}.zip" | sed -n '1,200p'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}.zip
          path: dist/${{ env.PLUGIN_NAME }}.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download built ZIP
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}.zip
          path: dist

      - name: Publish GitHub Release with ZIP
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ env.PLUGIN_NAME }}.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
