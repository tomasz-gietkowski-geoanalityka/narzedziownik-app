name: Build QGIS Plugin ZIP (git archive)

on:
  push:
    tags:
      - "v*.*.*"    # np. v1.0.0
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§¾ Get repository name
        id: repo
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          echo "name=${REPO_NAME}" >> "$GITHUB_OUTPUT"
          echo "Detected repository name: ${REPO_NAME}"

      - name: ðŸ§° Build ZIP via git archive
        run: |
          set -euo pipefail
          mkdir -p dist
          REPO_NAME="${{ steps.repo.outputs.name }}"

          # Tworzymy ZIP z prefiksem rÃ³wnym nazwie repo
          git archive --format=zip --prefix="${REPO_NAME}/" -o "dist/${REPO_NAME}.zip" HEAD

          echo "âœ… ZIP utworzony:"
          unzip -l "dist/${REPO_NAME}.zip" | head -n 20

      - name: ðŸ“¦ Upload ZIP as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.repo.outputs.name }}.zip
          path: dist/${{ steps.repo.outputs.name }}.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Download built ZIP
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.repository.name }}.zip
          path: dist

      - name: ðŸš€ Publish GitHub Release with ZIP
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ github.event.repository.name }}.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
