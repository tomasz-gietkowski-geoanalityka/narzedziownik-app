name: Build QGIS Plugin ZIP (git archive)

on:
  push:
    tags: ["v*.*.*"]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute repo name
        id: repo
        run: echo "name=${GITHUB_REPOSITORY#*/}" >> "$GITHUB_OUTPUT"

      - name: Build ZIP via git archive (respects .gitattributes export-ignore)
        run: |
          set -euo pipefail
          mkdir -p dist
          REPO_NAME="${{ steps.repo.outputs.name }}"
          git archive --format=zip --prefix="${REPO_NAME}/" -o "dist/${REPO_NAME}.zip" HEAD
          echo "ZIP content:"
          unzip -l "dist/${REPO_NAME}.zip" | sed -n '1,40p'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.repo.outputs.name }}.zip
          path: dist/${{ steps.repo.outputs.name }}.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download built ZIP
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.repository.name }}.zip
          path: dist

      - name: Publish GitHub Release with ZIP
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ github.event.repository.name }}.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
